<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Xiangqi Master Pro</title>
    <style>
      :root {
        --bg-color: #2c3e50;
        --panel-bg: rgba(255, 255, 255, 0.1);
        --text-color: #ecf0f1;
        --accent-red: #c0392b;
        --accent-black: #000000;
        --board-wood: #e6b086;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      h1 {
        margin: 10px 0;
        font-size: 1.5rem;
      }

      /* --- LAYOUT --- */
      .main-container {
        display: flex;
        gap: 20px;
        padding: 10px;
        width: 100%;
        max-width: 1200px;
        box-sizing: border-box;
      }

      /* Mobile Optimization: Stack columns on small screens */
      @media (max-width: 850px) {
        .main-container {
          flex-direction: column;
          align-items: center;
        }
        .sidebar {
          width: 100%;
          max-width: 450px;
        }
      }

      /* --- BOARD --- */
      .board-frame {
        background: #5d4037;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      .board-wrapper {
        position: relative;
        width: 400px;
        height: 450px;
        background: #deb887;
        user-select: none;
        transition: transform 0.5s ease;
      }

      /* Responsive Board for Mobile */
      @media (max-width: 450px) {
        .board-wrapper {
          width: 90vw;
          height: 101.25vw; /* Maintain 400:450 ratio */
        }
        .board-grid {
          width: 100%;
          height: 100%;
        }
      }

      /* FLIP LOGIC */
      .board-wrapper.flipped {
        transform: rotate(180deg);
      }
      .board-wrapper.flipped .piece {
        /* Counter rotate pieces to keep them upright */
        transform: translate(-50%, -50%) rotate(180deg);
      }

      .board-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .river-text {
        font-family: "KaiTi", "STKaiti", serif;
        font-size: 24px;
        fill: #5d4037;
        text-anchor: middle;
      }

      /* --- PIECES --- */
      .interaction-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
      }

      .piece {
        position: absolute;
        width: 10%;
        height: 8.88%;
        border-radius: 50%;
        background: #fdf5e6;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4),
          inset 0 0 5px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "KaiTi", "STKaiti", serif;
        font-weight: bold;
        font-size: 1.4rem;
        cursor: pointer;
        transform: translate(
          -50%,
          -50%
        ); /* Center piece on grid intersection */
        transition: top 0.2s, left 0.2s, transform 0.5s;
        z-index: 20;
      }

      .piece.red {
        color: #c0392b;
        border: 2px solid #c0392b;
      }
      .piece.black {
        color: #000;
        border: 2px solid #000;
      }
      .piece.selected {
        background: #ffeaa7;
        box-shadow: 0 0 15px #ffeaa7;
        z-index: 30;
      }

      /* --- SIDEBAR & UI --- */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 300px;
      }

      .glass-panel {
        background: var(--panel-bg);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
      }

      textarea {
        width: 100%;
        height: 80px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #555;
        color: #fff;
        padding: 5px;
        margin-bottom: 10px;
        box-sizing: border-box;
        font-family: monospace;
      }

      /* Buttons */
      .btn-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 4px;
        background: #34495e;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
        touch-action: manipulation;
      }
      button:hover {
        background: #455a64;
      }
      button:active {
        transform: translateY(1px);
      }

      /* --- EDIT MODE PALETTE --- */
      #editor-palette {
        display: none;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
        background: rgba(0, 0, 0, 0.2);
        padding: 10px;
        border-radius: 4px;
      }
      #editor-palette.show {
        display: flex;
      }
      .palette-piece {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: 2px solid transparent;
      }
      .palette-piece.selected {
        border-color: yellow;
        background: #fff;
      }

      /* --- SPLASH SCREEN --- */
      #splash-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #splash-overlay.show {
        opacity: 1;
      }

      #splash-text {
        font-family: "KaiTi", "STKaiti", serif;
        font-size: 5rem;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        transform: scale(0);
      }

      .anim-pop {
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }

      @keyframes popIn {
        0% {
          transform: scale(0);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <h1>Xiangqi Master Pro</h1>

    <div class="main-container">
      <div class="board-frame">
        <div class="board-wrapper" id="boardWrapper">
          <svg class="board-grid" viewBox="0 0 400 450">
            <rect
              x="2"
              y="2"
              width="396"
              height="446"
              fill="none"
              stroke="#5d4037"
              stroke-width="4"
            />
            <line
              x1="2"
              y1="50"
              x2="398"
              y2="50"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="100"
              x2="398"
              y2="100"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="150"
              x2="398"
              y2="150"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="200"
              x2="398"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="250"
              x2="398"
              y2="250"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="300"
              x2="398"
              y2="300"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="350"
              x2="398"
              y2="350"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="2"
              y1="400"
              x2="398"
              y2="400"
              stroke="#5d4037"
              stroke-width="1"
            />

            <line
              x1="50"
              y1="2"
              x2="50"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="50"
              y1="250"
              x2="50"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="100"
              y1="2"
              x2="100"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="100"
              y1="250"
              x2="100"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="150"
              y1="2"
              x2="150"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="150"
              y1="250"
              x2="150"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="200"
              y1="2"
              x2="200"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="200"
              y1="250"
              x2="200"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="250"
              y1="2"
              x2="250"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="250"
              y1="250"
              x2="250"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="300"
              y1="2"
              x2="300"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="300"
              y1="250"
              x2="300"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="350"
              y1="2"
              x2="350"
              y2="200"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="350"
              y1="250"
              x2="350"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />

            <line
              x1="150"
              y1="2"
              x2="250"
              y2="100"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="250"
              y1="2"
              x2="150"
              y2="100"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="150"
              y1="350"
              x2="250"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />
            <line
              x1="250"
              y1="350"
              x2="150"
              y2="448"
              stroke="#5d4037"
              stroke-width="1"
            />

            <text x="100" y="235" class="river-text">楚 河</text>
            <text x="300" y="235" class="river-text">漢 界</text>
          </svg>

          <div
            class="interaction-layer"
            id="gridLayer"
            onclick="game.handleBoardClick(event)"
          ></div>
        </div>
      </div>

      <div class="sidebar">
        <div class="glass-panel">
          <div id="status" class="status-box">Red's Turn</div>
          <div class="btn-row">
            <button style="background: #2980b9" onclick="game.toggleFlip()">
              Flip Board
            </button>
            <button onclick="game.undo()">Undo</button>
            <button style="background: #c0392b" onclick="game.reset()">
              Reset
            </button>
          </div>
          <div class="btn-row">
            <button
              style="font-size: 0.8em; opacity: 0.7"
              onclick="ui.showSplash('checkmate')"
            >
              Simulate Mate
            </button>
            <button
              style="font-size: 0.8em; opacity: 0.7"
              onclick="ui.showSplash('capture')"
            >
              Simulate Capture
            </button>
          </div>
        </div>

        <div class="glass-panel">
          <div class="btn-row">
            <button onclick="game.toggleEditMode()">Setup Mode</button>
            <button
              onclick="game.clearBoard()"
              id="btnClear"
              style="display: none; background: #e74c3c"
            >
              Clear Board
            </button>
          </div>

          <div id="editor-palette">
            <div
              style="
                font-size: 0.8rem;
                width: 100%;
                margin-bottom: 5px;
                opacity: 0.8;
              "
            >
              Click piece, then click board to place/replace. Click square to
              clear.
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('R', event)"
            >
              車
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('N', event)"
            >
              馬
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('B', event)"
            >
              相
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('A', event)"
            >
              仕
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('K', event)"
            >
              帥
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('C', event)"
            >
              炮
            </div>
            <div
              class="palette-piece"
              style="color: #c0392b"
              onclick="game.selectPalettePiece('P', event)"
            >
              兵
            </div>
            <div
              style="width: 100%; height: 1px; background: #555; margin: 5px 0"
            ></div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('r', event)"
            >
              車
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('n', event)"
            >
              馬
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('b', event)"
            >
              象
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('a', event)"
            >
              士
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('k', event)"
            >
              將
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('c', event)"
            >
              炮
            </div>
            <div
              class="palette-piece"
              style="color: #000"
              onclick="game.selectPalettePiece('p', event)"
            >
              卒
            </div>
          </div>
        </div>

        <div class="glass-panel">
          <div style="font-size: 0.8rem; margin-bottom: 5px; opacity: 0.7">
            HuaShan / FEN / PGN
          </div>
          <textarea
            id="ioInput"
            placeholder="Paste HuaShan format here..."
          ></textarea>

          <input
            type="file"
            id="file-selector"
            accept=".xqpro,.txt,.pgn,text/plain"
            style="display: none"
            onchange="game.loadFile(event)"
          />

          <div class="btn-row">
            <button
              style="background: #27ae60"
              onclick="document.getElementById('file-selector').click()"
            >
              Load File
            </button>
            <button onclick="game.loadFromInput()">Load Text</button>
          </div>
          <div class="btn-row">
            <button onclick="game.copyToClipboard()">Copy Text</button>
          </div>
        </div>
      </div>
    </div>

    <div id="splash-overlay">
      <div id="splash-text"></div>
    </div>

    <script>
      // --- 1. UI HELPER ---
      const ui = {
        boardWrapper: document.getElementById("boardWrapper"),
        gridLayer: document.getElementById("gridLayer"),
        status: document.getElementById("status"),
        ioInput: document.getElementById("ioInput"),
        palette: document.getElementById("editor-palette"),
        overlay: document.getElementById("splash-overlay"),
        splashText: document.getElementById("splash-text"),

        renderBoard: (grid) => {
          ui.gridLayer.innerHTML = "";
          for (let r = 0; r < 10; r++) {
            for (let c = 0; c < 9; c++) {
              const pieceChar = grid[r][c];
              if (pieceChar) {
                const el = document.createElement("div");
                el.className = `piece ${ui.getSide(pieceChar)}`;
                el.innerText = ui.getLabel(pieceChar);

                // Coordinates based on 400x450 grid scaling
                const leftPct = ((2 + c * (396 / 8)) / 400) * 100;
                const topPct = ((2 + r * (446 / 9)) / 450) * 100;

                el.style.left = `${leftPct}%`;
                el.style.top = `${topPct}%`;

                el.dataset.r = r;
                el.dataset.c = c;

                ui.gridLayer.appendChild(el);
              }
            }
          }
        },

        getSide: (char) => (char === char.toUpperCase() ? "red" : "black"),

        getLabel: (char) => {
          const map = {
            K: "帥",
            A: "仕",
            B: "相",
            N: "馬",
            R: "車",
            C: "炮",
            P: "兵",
            k: "將",
            a: "士",
            b: "象",
            n: "馬",
            r: "車",
            c: "炮",
            p: "卒",
          };
          return map[char] || "?";
        },

        showSplash: (type) => {
          let text = "";
          let color = "white";
          if (type === "capture") {
            text = "吃!";
            color = "#f1c40f";
          }
          if (type === "checkmate") {
            text = "絕殺!";
            color = "#e74c3c";
          }
          if (type === "smothered") {
            text = "悶宮!";
            color = "#e74c3c";
          }

          ui.splashText.innerText = text;
          ui.splashText.style.color = color;

          ui.splashText.classList.remove("anim-pop");
          void ui.splashText.offsetWidth; // Trigger reflow
          ui.splashText.classList.add("anim-pop");

          ui.overlay.classList.add("show");
          setTimeout(() => ui.overlay.classList.remove("show"), 1500);
        },
      };

      // --- 2. GAME LOGIC ---
      const game = {
        grid: [],
        turn: "w",
        editMode: false,
        selectedPalettePiece: null,
        selectedSquare: null,

        init: () => {
          game.loadFEN(
            "rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1"
          );
        },

        loadFEN: (fen) => {
          const parts = fen.split(" ");
          const rows = parts[0].split("/");
          game.grid = Array(10)
            .fill()
            .map(() => Array(9).fill(null));

          for (let r = 0; r < rows.length; r++) {
            let c = 0;
            for (let i = 0; i < rows[r].length; i++) {
              const char = rows[r][i];
              if (!isNaN(char)) {
                c += parseInt(char);
              } else {
                game.grid[r][c] = char;
                c++;
              }
            }
          }
          game.turn = parts[1] || "w";
          document.getElementById("status").innerText =
            game.turn === "w" ? "Red's Turn" : "Black's Turn";
          ui.renderBoard(game.grid);
        },

        getFEN: () => {
          let fen = "";
          for (let r = 0; r < 10; r++) {
            let empty = 0;
            for (let c = 0; c < 9; c++) {
              if (game.grid[r][c] == null) empty++;
              else {
                if (empty > 0) {
                  fen += empty;
                  empty = 0;
                }
                fen += game.grid[r][c];
              }
            }
            if (empty > 0) fen += empty;
            if (r < 9) fen += "/";
          }
          return fen + ` ${game.turn} - - 0 1`;
        },

        // --- VALIDATION FIX ---
        validatePlacement: (piece, r, c) => {
          if (!piece) return true;

          const type = piece.toUpperCase();
          const isRed = piece === piece.toUpperCase();

          // King (K) and Advisor (A) - Palace Logic
          if (type === "K" || type === "A") {
            if (c < 3 || c > 5) return false;

            if (isRed) {
              if (r < 7) return false; // Red Palace: Rows 7-9
            } else {
              if (r > 2) return false; // Black Palace: Rows 0-2
            }
          }

          // Elephant (B) - River Logic
          if (type === "B") {
            if (isRed) {
              if (r < 5) return false; // Red Elephants must stay in bottom half (Rows 5-9)
            } else {
              if (r > 4) return false; // Black Elephants must stay in top half (Rows 0-4)
            }
          }
          return true;
        },

        // --- CLICK HANDLER FIX (FLIP LOGIC) ---
        handleBoardClick: (e) => {
          const rect = ui.boardWrapper.getBoundingClientRect();

          // 1. Calculate raw Row/Col based on click position
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          let c = Math.round((((x / rect.width) * 400 - 2) * 8) / 396);
          let r = Math.round((((y / rect.height) * 450 - 2) * 9) / 446);

          // 2. FLIP FIX: Invert coordinates if board is visually flipped
          const isFlipped = ui.boardWrapper.classList.contains("flipped");
          if (isFlipped) {
            c = 8 - c;
            r = 9 - r;
          }

          if (c < 0 || c > 8 || r < 0 || r > 9) return;

          // --- EDIT MODE LOGIC (WITH VALIDATION) ---
          if (game.editMode) {
            if (game.selectedPalettePiece) {
              if (game.validatePlacement(game.selectedPalettePiece, r, c)) {
                game.grid[r][c] = game.selectedPalettePiece;
                ui.renderBoard(game.grid);
              } else {
                alert(
                  "Invalid placement! King/Advisor must be in the palace, Elephant must stay on its side."
                );
              }
            } else {
              // Clear square
              game.grid[r][c] = null;
              ui.renderBoard(game.grid);
            }
            return;
          }

          // --- PLAY MODE LOGIC (Simplified) ---
          if (!game.selectedSquare) {
            const piece = game.grid[r][c];
            if (!piece) return;

            const isRed = piece === piece.toUpperCase();
            if ((game.turn === "w" && isRed) || (game.turn === "b" && !isRed)) {
              game.selectedSquare = { r, c };
              document.querySelectorAll(".piece").forEach((el) => {
                if (
                  parseInt(el.dataset.r) === r &&
                  parseInt(el.dataset.c) === c
                ) {
                  el.classList.add("selected");
                } else {
                  el.classList.remove("selected");
                }
              });
            }
          } else {
            const fromR = game.selectedSquare.r;
            const fromC = game.selectedSquare.c;
            const targetPiece = game.grid[r][c];

            const movingPiece = game.grid[fromR][fromC];
            const isMovingRed = movingPiece === movingPiece.toUpperCase();

            if (targetPiece) {
              const isTargetRed = targetPiece === targetPiece.toUpperCase();
              if (isMovingRed === isTargetRed) {
                game.selectedSquare = null;
                game.handleBoardClick(e);
                return;
              }
              ui.showSplash("capture");
            }

            game.grid[r][c] = game.grid[fromR][fromC];
            game.grid[fromR][fromC] = null;

            game.turn = game.turn === "w" ? "b" : "w";
            document.getElementById("status").innerText =
              game.turn === "w" ? "Red's Turn" : "Black's Turn";
            game.selectedSquare = null;
            ui.renderBoard(game.grid);
          }
        },

        // --- EDIT MODE ---
        toggleEditMode: () => {
          game.editMode = !game.editMode;
          const btn = document.querySelector(
            'button[onclick="game.toggleEditMode()"]'
          );
          const clearBtn = document.getElementById("btnClear");

          if (game.editMode) {
            btn.innerText = "Done Setup";
            btn.style.background = "#e67e22";
            ui.palette.classList.add("show");
            clearBtn.style.display = "block";
          } else {
            btn.innerText = "Setup Mode";
            btn.style.background = "";
            ui.palette.classList.remove("show");
            clearBtn.style.display = "none";
            game.selectedPalettePiece = null;
            document
              .querySelectorAll(".palette-piece")
              .forEach((el) => el.classList.remove("selected"));
          }
        },

        clearBoard: () => {
          if (confirm("Clear entire board?")) {
            game.grid = Array(10)
              .fill()
              .map(() => Array(9).fill(null));
            ui.renderBoard(game.grid);
          }
        },

        selectPalettePiece: (char, event) => {
          game.selectedPalettePiece = char;
          document
            .querySelectorAll(".palette-piece")
            .forEach((el) => el.classList.remove("selected"));
          event.currentTarget.classList.add("selected");
        },

        // --- UTILS ---
        toggleFlip: () => {
          ui.boardWrapper.classList.toggle("flipped");
        },

        reset: () => {
          game.init();
        },

        undo: () => {
          alert("Undo not implemented in this demo (requires history stack).");
        },

        // --- I/O & PARSER ---
        loadFile: (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            ui.ioInput.value = e.target.result;
            game.loadFromInput();
          };
          reader.readAsText(file);
        },

        loadFromInput: () => {
          const text = ui.ioInput.value;
          if (!text.trim()) return;

          const huaShan = game.parseHuaShan(text);
          if (huaShan.startFen) {
            game.loadFEN(huaShan.startFen);
            alert("Loaded HuaShan Format!");
          } else if (text.includes("/")) {
            game.loadFEN(text);
          } else {
            alert("Could not detect valid FEN or HuaShan format.");
          }
        },

        parseHuaShan: (text) => {
          const result = { startFen: null, moves: [] };
          const fenMatch = text.match(/\[FEN "([^"]+)"\]/);
          if (fenMatch) {
            result.startFen = fenMatch[1];
          } else if (text.includes("rnbakabnr")) {
            const lines = text.split("\n");
            const fenLine = lines.find(
              (l) => l.includes("/") && l.includes("rnbakabnr")
            );
            if (fenLine) result.startFen = fenLine.trim();
          }
          return result;
        },

        copyToClipboard: () => {
          const text = ui.ioInput.value || game.getFEN();
          navigator.clipboard.writeText(text).then(() => {
            alert("Copied to clipboard!");
          });
        },

        exportXQPro: () => {
          alert("Export logic would go here.");
        },
      };

      // Initialize
      game.init();
    </script>
  </body>
</html>
