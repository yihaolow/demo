<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xiangqi Collection</title>
    <style>
      body {
        font-family: -apple-system, sans-serif;
        background: #fafafa;
        padding-bottom: 50px;
      }
      h1.main-title {
        text-align: center;
        margin-top: 30px;
        color: #333;
      }
      .xq-player {
        font-family: "Helvetica Neue", Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-width: 450px;
        margin: 30px auto;
        user-select: none;
        border: 1px solid #eee;
      }
      .game-title {
        width: 100%;
        max-width: 450px;
        margin: 0 auto;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        color: #444;
        padding-top: 20px;
      }
      .xq-board-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 9/10;
        background: #fdf5e6;
        border: 2px solid #8b5a2b;
        margin-bottom: 10px;
      }
      .xq-grid {
        width: 100%;
        height: 100%;
        display: block;
        pointer-events: none;
      }
      .line {
        stroke: #4b3621;
        stroke-width: 1.5;
        vector-effect: non-scaling-stroke;
      }
      .border {
        stroke: #4b3621;
        stroke-width: 4;
        fill: none;
        vector-effect: non-scaling-stroke;
      }
      .river-text {
        font-family: "KaiTi", serif;
        font-size: 8px;
        fill: #4b3621;
        opacity: 0.8;
        text-anchor: middle;
        dominant-baseline: middle;
        font-weight: bold;
        letter-spacing: 5px;
      }
      .piece {
        position: absolute;
        width: 11.11%;
        height: 10%;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease-out;
        z-index: 20;
      }
      .piece-inner {
        width: 90%;
        height: 90%;
        border-radius: 50%;
        background: #fcfcfc;
        border: 2px solid #888;
        box-shadow: 1px 2px 4px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "KaiTi", "STKaiti", serif;
        font-weight: bold;
        font-size: clamp(12px, 3.5cqw, 28px);
        container-type: inline-size;
        position: relative;
      }
      .piece-inner::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.15);
      }
      .red .piece-inner {
        color: #c0392b;
        border-color: #c0392b;
      }
      .black .piece-inner {
        color: #2d3436;
        border-color: #2d3436;
      }
      .marker {
        position: absolute;
        width: 11.11%;
        height: 10%;
        z-index: 10;
      }
      .last-move::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 160, 233, 0.3);
        border-radius: 12px;
        box-sizing: border-box;
      }
      .xq-controls {
        display: flex;
        gap: 4px;
        width: 100%;
      }
      button {
        flex: 1;
        padding: 10px 0;
        border: 1px solid #ccc;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        color: #444;
        font-size: 14px;
      }
      button:hover {
        background: #e9ecef;
      }
      .xq-status {
        font-size: 14px;
        font-weight: bold;
        color: #555;
        margin-bottom: 8px;
        text-align: center;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <h1 class="main-title">Xiangqi Games Collection</h1>
    <div class="game-title">Arthur Win Ruo Qi 10 Jan 26</div>
    <div id="xq_game_1"></div>
    <div class="game-title">Ruo Qi Win Arthur 10 Jan 26</div>
    <div id="xq_game_2"></div>
    <script>
      class XiangqiPlayer {
        constructor(cId, moves, fen) {
          this.c = document.getElementById(cId);
          if (!this.c) return;
          this.fen =
            fen ||
            "rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1";
          this.moves = [];
          this.idx = -1;
          this.flipped = false;
          this.playing = false;
          this.timer = null;
          this.P = {
            r: "車",
            n: "馬",
            e: "象",
            b: "象",
            a: "士",
            k: "將",
            c: "砲",
            p: "卒",
            R: "俥",
            N: "傌",
            E: "相",
            B: "相",
            A: "仕",
            K: "帥",
            C: "炮",
            P: "兵",
          };
          this.board = [];
          this.parseMoves(moves);
          this.reset();
          this.initUI();
          this.draw();
        }
        reset() {
          let parts = this.fen.split(" ");
          let rows = parts[0].split("/");
          this.board = Array(10)
            .fill(null)
            .map(() => Array(9).fill(null));
          rows.forEach((r, y) => {
            let x = 0;
            for (let char of r) {
              if (isNaN(char)) {
                let color = char === char.toUpperCase() ? "r" : "b";
                this.board[y][x] = color + char;
                x++;
              } else {
                x += parseInt(char);
              }
            }
          });
          this.idx = -1;
        }
        parseMoves(str) {
          let raw = str || "";
          if (raw.includes("movelist")) {
            let m = raw.match(/\[DhtmlXQ_movelist\](.*?)\[/);
            if (m) raw = m[1];
          }
          let matches = raw.match(/\d{4}/g);
          this.moves = matches
            ? matches.map((m) => ({
                fx: +m[0],
                fy: +m[1],
                tx: +m[2],
                ty: +m[3],
              }))
            : [];
        }
        step(dir) {
          if (dir === 1) {
            if (this.idx >= this.moves.length - 1) {
              this.stop();
              return;
            }
            this.idx++;
            let m = this.moves[this.idx];
            m.captured = this.board[m.ty][m.tx];
            this.board[m.ty][m.tx] = this.board[m.fy][m.fx];
            this.board[m.fy][m.fx] = null;
          } else {
            if (this.idx < 0) return;
            let m = this.moves[this.idx];
            this.board[m.fy][m.fx] = this.board[m.ty][m.tx];
            this.board[m.ty][m.tx] = m.captured;
            this.idx--;
          }
          this.draw();
        }
        initUI() {
          this.c.classList.add("xq-player");
          this.c.innerHTML = `
            <div class="xq-status">Ready</div>
            <div class="xq-board-wrapper">
                <svg class="xq-grid" viewBox="0 0 450 500" preserveAspectRatio="none">
                    <rect x="0" y="0" width="450" height="500" fill="#fdf5e6"/>
                    <rect x="25" y="25" width="400" height="450" class="border"/>
                    ${[75, 125, 175, 225, 275, 325, 375, 425]
                      .map(
                        (y) =>
                          '<line x1="25" y1="' +
                          y +
                          '" x2="425" y2="' +
                          y +
                          '" class="line"/>'
                      )
                      .join("")}
                    ${[75, 125, 175, 275, 325, 375]
                      .map(
                        (x) =>
                          '<line x1="' +
                          x +
                          '" y1="25" x2="' +
                          x +
                          '" y2="225" class="line"/><line x1="' +
                          x +
                          '" y1="275" x2="' +
                          x +
                          '" y2="475" class="line"/>'
                      )
                      .join("")}
                    <line x1="225" y1="25" x2="225" y2="225" class="line"/><line x1="225" y1="275" x2="225" y2="475" class="line"/>
                    <line x1="175" y1="25" x2="275" y2="125" class="line"/><line x1="275" y1="25" x2="175" y2="125" class="line"/>
                    <line x1="175" y1="375" x2="275" y2="475" class="line"/><line x1="275" y1="375" x2="175" y2="475" class="line"/>
                    <text x="110" y="250" class="river-text" style="font-size:36px">楚 河</text>
                </svg>
                <div class="layer-mk" style="position:absolute;top:0;left:0;width:100%;height:100%"></div>
                <div class="layer-pc" style="position:absolute;top:0;left:0;width:100%;height:100%"></div>
            </div>
            <div style="display:flex; gap:5px;">
                <button data-a="start">|&lt;</button>
                <button data-a="prev">&lt;</button>
                <button data-a="play">▶</button>
                <button data-a="next">&gt;</button>
                <button data-a="end">&gt;|</button>
                <button data-a="flip">Flip</button>
            </div>
        `;
          this.c.querySelectorAll("button").forEach((b) => {
            b.onclick = () => {
              let a = b.getAttribute("data-a");
              if (a === "start") {
                this.stop();
                while (this.idx >= 0) this.step(-1);
              }
              if (a === "prev") {
                this.stop();
                this.step(-1);
              }
              if (a === "next") {
                this.stop();
                this.step(1);
              }
              if (a === "end") {
                this.stop();
                while (this.idx < this.moves.length - 1) this.step(1);
              }
              if (a === "play") this.toggle();
              if (a === "flip") {
                this.flipped = !this.flipped;
                this.draw();
              }
            };
          });
          this.el = {
            mk: this.c.querySelector(".layer-mk"),
            pc: this.c.querySelector(".layer-pc"),
            st: this.c.querySelector(".xq-status"),
            pl: this.c.querySelector("button[data-a='play']"),
          };
        }
        draw() {
          this.el.mk.innerHTML = "";
          this.el.pc.innerHTML = "";
          if (this.idx >= 0) {
            let m = this.moves[this.idx];
            [
              { x: m.fx, y: m.fy },
              { x: m.tx, y: m.ty },
            ].forEach((p) => {
              let d = document.createElement("div");
              d.className = "marker last-move";
              let px = this.toPx(p.x, p.y);
              Object.assign(d.style, {
                left: px.l + "%",
                top: px.t + "%",
                width: "11.11%",
                height: "10%",
                position: "absolute",
              });
              this.el.mk.appendChild(d);
            });
          }
          for (let y = 0; y < 10; y++) {
            for (let x = 0; x < 9; x++) {
              let p = this.board[y][x];
              if (p) {
                let d = document.createElement("div");
                d.className = "piece " + (p[0] === "r" ? "red" : "black");
                d.innerHTML = `<div class="piece-inner">${
                  this.P[p[1]] || p[1]
                }</div>`;
                let px = this.toPx(x, y);
                Object.assign(d.style, { left: px.l + "%", top: px.t + "%" });
                this.el.pc.appendChild(d);
              }
            }
          }
          this.el.st.innerText = `Move: ${this.idx + 1} / ${this.moves.length}`;
          this.el.pl.innerText = this.playing ? "||" : "▶";
        }
        toPx(x, y) {
          if (this.flipped) return { l: (8 - x) * 11.11, t: (9 - y) * 10 };
          return { l: x * 11.11, t: y * 10 };
        }
        toggle() {
          if (this.playing) this.stop();
          else {
            this.playing = true;
            this.draw();
            this.timer = setInterval(() => {
              if (this.idx < this.moves.length - 1) this.step(1);
              else this.stop();
            }, 1000);
          }
        }
        stop() {
          this.playing = false;
          clearInterval(this.timer);
          this.draw();
        }
      }
      // Initialize
      window.onload = function () {
        new XiangqiPlayer(
          "xq_game_1",
          "774710227967706219078070897920421727304109190010262563647973121666657282736370726564101467557279636279692728828628238689627269687279898855438887432287672343"
        );
        new XiangqiPlayer(
          "xq_game_2",
          "79671242192710220919001017137062262563646947808159488151778751568979566679776465476566656759656677734246274666467372468687678666677762547270434477714445706020426062666271705041596762671914676948595435146469641383648483638474708074708040"
        );
      };
    </script>
  </body>
</html>
